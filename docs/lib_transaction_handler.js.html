<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/transaction/handler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/transaction/handler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * tx handler class
 * @class
 */
class Handler {
    /**
     * initialize with tx and rpc
     * @constructor
     * @param {Transaction.Tx} tx 
     * @param {API.RPC} rpc 
     * @param {boolean} log console.log output
     */
    constructor(tx, rpc, log = false) {
        let self = this;
        this.tx = tx;
        this.log = log;
        this.Pending = (res) => {
            if (self.log) console.log(`Pending... tx: ${res.hash}, ${JSON.stringify(self.tx.actions)}`);
            self.status = 'pending';
        };
        this.Success = (res) => {
            if (self.log) console.log(`Success... tx, receipt: ${JSON.stringify(res)}`);
            self.status = 'success';
        };
        this.Failed = (res) => {
            if (self.log) console.log(`error... tx failed, res: ${JSON.stringify(res)}, tx: ${JSON.stringify(self.tx)}`);
            self.status = 'failed';
        };
        this.rpc = rpc;
        this.status = 'idle';
        this.hash = null
    }
    /**
     * 
     * @param {Function} callback 
     * @returns {Transaction.Handler}
     */
    onPending(callback) {
        let self = this;
        this.Pending = (res) => {
            self.status = 'pending';
            try {
                let p = callback(res);
                if (typeof p === 'object' &amp;&amp; typeof p.catch === 'function') {
                    p.catch(e => {
                        if (self.log) console.error(`on pending failed. ${e}`)
                    })
                }
            } catch (e) {
                if (self.log) console.error(`on pending failed. ${e}`)
            }
        };
        return this
    }
    /**
     * 
     * @param {Function} callback 
     * @returns {Transaction.Handler}
     */
    onSuccess(callback) {
        let self = this;
        this.Success = (res) => {
            self.status = 'success';
            try {
                let p = callback(res);
                if (typeof p === 'object' &amp;&amp; typeof p.catch === 'function') {
                    p.catch(e => {
                        if (self.log) console.error(`on success failed. ${e}`)
                    })
                }
            } catch (e) {
                if (self.log) console.error(`on success failed. ${e}`)
            }
        };
        return this
    }
    /**
     * 
     * @param {Function} callback 
     * @returns {Transaction.Handler}
     */
    onFailed(callback) {
        let self = this;
        this.Failed = (res) => {
            self.status = 'failed';
            try {
                let p = callback(res);
                if (typeof p === 'object' &amp;&amp; typeof p.catch === 'function') {
                    p.catch(e => {
                        if (self.log) console.error(`on failed failed. ${e}`)
                    })
                }
            } catch (e) {
                if (self.log) console.error(`on failed failed. ${e}`)
            }
        };
        return this
    }
    /**
     * 
     * @returns {void}
     */
    sendTx() {
        let self = this;
        self.rpc.transaction.sendTx(self.tx).then(res => {
            self.hash = res.hash;
            self.Pending(res)
        }).catch(e => {
            self.Failed(`send tx failed: ${e}`)
        });
        return this
    }
    /**
     * 
     * @param {IOST.Account} publisher publisher account object
     * @param {Array&lt;{ account: IOST.Account, permision: string }>} signers accuont object and permission pair list
     * @returns {void}
     */
    signAndSend(publisher, signers = []) {
        for (const signer of signers) {
            this.tx.addSigner(signer.account.id, signer.permission)
        }
        for (const signer of signers) {
            signer.account.sign(this.tx, signer.permission)
        }
        publisher.publishSign(this.tx);
        this.sendTx()
    }
    /**
     * 
     * @param {number} interval default 250 ms
     * @param {number} times default 100 times request
     * @returns {void}
     */
    listen(interval = 250, times = 100) {
        let self = this;
        let i = 1;
        let id = setInterval(() => {
            if (self.status === 'idle') {
                return
            }
            if (self.status === 'success' || self.status === 'failed' || i > times) {
                clearInterval(id);
                if (self.status !== 'success' &amp;&amp; self.status !== 'failed' &amp;&amp; i > times) {
                    self.Failed('error: tx ' + self.hash + ' on chain timeout.');
                }
                return
            }
            i++;
            self.rpc.transaction.getTxReceiptByTxHash(self.hash).then(res => {
                if (self.log) console.log(`[${interval * i / 1e3} seconds]`);
                if (res.status_code === 'SUCCESS' &amp;&amp; self.status === 'pending') {
                    self.Success(res)
                } else if (res.status_code !== undefined &amp;&amp; self.status === 'pending') {
                    self.Failed(res)
                }
            }).catch(e => {
                // receipt not found (tx has not mined)
                if (self.log) process.stdout.write('.')
            })
        }, interval)
    }
}

module.exports = Handler</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a></li><li><a href="Codec.html">Codec</a></li><li><a href="Contract.html">Contract</a></li><li><a href="Ed25519.html">Ed25519</a></li><li><a href="Handler.html">Handler</a></li><li><a href="IOST.html">IOST</a></li><li><a href="KeyPair.html">KeyPair</a></li><li><a href="RPC.html">RPC</a></li><li><a href="Secp256K1.html">Secp256K1</a></li><li><a href="Signature.html">Signature</a></li><li><a href="Tx.html">Tx</a></li></ul><h3>Global</h3><ul><li><a href="global.html#assignPermission">assignPermission</a></li><li><a href="global.html#balanceOf">balanceOf</a></li><li><a href="global.html#buy">buy</a></li><li><a href="global.html#cancelDelaytx">cancelDelaytx</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#getAccountInfo">getAccountInfo</a></li><li><a href="global.html#getBalance">getBalance</a></li><li><a href="global.html#getBlockByHash">getBlockByHash</a></li><li><a href="global.html#getBlockByNum">getBlockByNum</a></li><li><a href="global.html#getChainInfo">getChainInfo</a></li><li><a href="global.html#getContract">getContract</a></li><li><a href="global.html#getContractStorage">getContractStorage</a></li><li><a href="global.html#getContractStorageFields">getContractStorageFields</a></li><li><a href="global.html#getGasRatio">getGasRatio</a></li><li><a href="global.html#getNodeInfo">getNodeInfo</a></li><li><a href="global.html#getRAMInfo">getRAMInfo</a></li><li><a href="global.html#getToken721Balance">getToken721Balance</a></li><li><a href="global.html#getToken721Metadata">getToken721Metadata</a></li><li><a href="global.html#getToken721Owner">getToken721Owner</a></li><li><a href="global.html#getTokenInfo">getTokenInfo</a></li><li><a href="global.html#getTxByHash">getTxByHash</a></li><li><a href="global.html#getTxReceiptByTxHash">getTxReceiptByTxHash</a></li><li><a href="global.html#issue">issue</a></li><li><a href="global.html#lend">lend</a></li><li><a href="global.html#ownerOf">ownerOf</a></li><li><a href="global.html#pledge">pledge</a></li><li><a href="global.html#receipt">receipt</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#revokePermission">revokePermission</a></li><li><a href="global.html#sell">sell</a></li><li><a href="global.html#sendTx">sendTx</a></li><li><a href="global.html#setCode">setCode</a></li><li><a href="global.html#signUp">signUp</a></li><li><a href="global.html#supply">supply</a></li><li><a href="global.html#tokenMetadata">tokenMetadata</a></li><li><a href="global.html#tokenOfOwnerByIndex">tokenOfOwnerByIndex</a></li><li><a href="global.html#totalSupply">totalSupply</a></li><li><a href="global.html#transfer">transfer</a></li><li><a href="global.html#transferFreeze">transferFreeze</a></li><li><a href="global.html#unpledge">unpledge</a></li><li><a href="global.html#updateCode">updateCode</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Mar 21 2020 15:10:01 GMT+0900 (Japan Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
