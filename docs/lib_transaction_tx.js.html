<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/transaction/tx.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/transaction/tx.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { SHA3 } = require('sha3');
const Codec = require('../crypto/codec');
const Signature = require('../crypto/signature');
/**
 * IOST Transaction
 * @class
 */
class Tx {
    /**
     * 
     * @constructor
     * @param {number} chainId mainnet: 1024, testnet: 1023, localhost: 1020
     * @param {number} gasLimit 
     * @param {number} gasRatio
     */
    constructor(chainId, gasLimit = 2000000, gasRatio = 1) {
        this.gasLimit = gasLimit;
        this.gasRatio = gasRatio;
        this.actions = [];
        this.signers = [];
        this.signatures = [];
        this.publisher = '';
        this.publisher_sigs = [];
        this.amount_limit = [];
        this.chainId = chainId;
        this.reserved = null
    }
    /**
     * 
     * @param {string} id iost account id
     * @param {string} permission active or owner
     * @returns {void}
     */
    addSigner(id, permission) {
        if (this.signers.indexOf(`${id}@${permission}`) === -1) {
            this.signers.push(`${id}@${permission}`)
        }
    }
    /**
     * 
     * @param {string} token token symbol
     * @param {string|number} amount default is 'unlimited'
     * @returns {void}
     */
    addApprove(token, amount = 'unlimited') {
        let index = null;
        for (let i = 0; i &lt; this.amount_limit.length; i++) {
            if (this.amount_limit[i].token === token) {
                if (this.amount_limit[i].value === 'unlimited') {
                    return 
                }
                index = i;
                break
            }
        }
        if (amount !== 'unlimited') {
            amount = Number(amount);
            if (Number.isNaN(amount)) {
                throw new Error('invalid amount')
            }
            if (index !== null) {
                amount += Number(this.amount_limit[index].value)
            }
            amount = amount.toFixed(8)
        }
        if (index === null) {
            this.amount_limit.push({
                token: token,
                value: amount
            })
        } else {
            this.amount_limit[index].value = amount
        }
    }
    /**
     * 
     * @returns {Array&lt;Parameters.AmountLimit>}
     */
    getApproveList() {
        return this.amount_limit
    }
    /**
     * 
     * @param {string} contract contract name
     * @param {string} abi funciton name
     * @param {Array&lt;number|string>} args args
     * @returns {void}
     */
    addAction(contract, abi, args) {
        this.actions.push({
            contract: contract,
            actionName: abi,
            data: JSON.stringify(args),
        })
    }
    /**
     * 
     * @param {number} expiration 
     * @param {number} delay 
     * @param {number} serverTimeDiff 
     * @returns {void}
     */
    setTime(expiration, delay, serverTimeDiff) {
        this.time = new Date().getTime() * 1e6 + serverTimeDiff;
        this.expiration = this.time + expiration * 1e9;
        this.delay = delay
    }
    _base_hash() {
        const hash = new SHA3(256);
        hash.update(this._bytes(0));
        return hash.digest('binary')
    }
    /**
     * 
     * @param {Crypto.KeyPair} keyPair secretKey and publicKey pair
     * @returns {void}
     */
    addSign(keyPair) {
        const signature = new Signature(this._base_hash(), keyPair);
        this.signatures.push(signature)
    }
    _publish_hash() {
        const hash = new SHA3(256);
        hash.update(this._bytes(1));
        return hash.digest('binary')
    }
    /**
     * 
     * @param {string} id publisher's iost account id
     * @param {Crypto.KeyPair} keyPair secretKey and publicKey pair
     * @returns {void}
     */
    addPublishSign(id, keyPair) {
        this.publisher = id;
        const info = this._publish_hash();
        const sig = new Signature(info, keyPair);
        this.publisher_sigs.push(sig)
    }
    _bytes(n) {
        let c = new Codec();
        c.pushInt64(this.time);
        c.pushInt64(this.expiration);
        c.pushInt64(this.gasRatio * 100);
        c.pushInt64(this.gasLimit * 100);
        c.pushInt64(this.delay);
        c.pushInt(this.chainId);
        if (!this.reserved) {
            c.pushInt(0)
        }

        c.pushInt(this.signers.length);
        for (let i = 0; i &lt; this.signers.length; i++) {
            c.pushString(this.signers[i])
        }
        c.pushInt(this.actions.length);
        for (let i = 0; i &lt; this.actions.length; i++) {
            let c2 = new Codec();
            c2.pushString(this.actions[i].contract);
            c2.pushString(this.actions[i].actionName);
            c2.pushString(this.actions[i].data);
            c.pushBytes(c2._buf)
        }
        c.pushInt(this.amount_limit.length);
        for (let i = 0; i &lt; this.amount_limit.length; i++) {
            let c2 = new Codec();
            c2.pushString(this.amount_limit[i].token);
            c2.pushString(this.amount_limit[i].value + "");
            c.pushBytes(c2._buf);
        }
        if (n > 0) {
            c.pushInt(this.signatures.length);
            for (let i = 0; i &lt; this.signatures.length; i++) {
                c.pushBytes(this.signatures[i]._bytes())
            }
        }
        return c._buf
    }
}

module.exports = Tx
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a></li><li><a href="Codec.html">Codec</a></li><li><a href="Contract.html">Contract</a></li><li><a href="Ed25519.html">Ed25519</a></li><li><a href="Handler.html">Handler</a></li><li><a href="IOST.html">IOST</a></li><li><a href="KeyPair.html">KeyPair</a></li><li><a href="RPC.html">RPC</a></li><li><a href="Secp256k1.html">Secp256k1</a></li><li><a href="Signature.html">Signature</a></li><li><a href="Tx.html">Tx</a></li></ul><h3>Global</h3><ul><li><a href="global.html#assignPermission">assignPermission</a></li><li><a href="global.html#balanceOf">balanceOf</a></li><li><a href="global.html#buy">buy</a></li><li><a href="global.html#cancelDelaytx">cancelDelaytx</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#getAccountInfo">getAccountInfo</a></li><li><a href="global.html#getBalance">getBalance</a></li><li><a href="global.html#getBlockByHash">getBlockByHash</a></li><li><a href="global.html#getBlockByNum">getBlockByNum</a></li><li><a href="global.html#getChainInfo">getChainInfo</a></li><li><a href="global.html#getContract">getContract</a></li><li><a href="global.html#getContractStorage">getContractStorage</a></li><li><a href="global.html#getContractStorageFields">getContractStorageFields</a></li><li><a href="global.html#getGasRatio">getGasRatio</a></li><li><a href="global.html#getNodeInfo">getNodeInfo</a></li><li><a href="global.html#getRAMInfo">getRAMInfo</a></li><li><a href="global.html#getToken721Balance">getToken721Balance</a></li><li><a href="global.html#getToken721Metadata">getToken721Metadata</a></li><li><a href="global.html#getToken721Owner">getToken721Owner</a></li><li><a href="global.html#getTokenInfo">getTokenInfo</a></li><li><a href="global.html#getTxByHash">getTxByHash</a></li><li><a href="global.html#getTxReceiptByTxHash">getTxReceiptByTxHash</a></li><li><a href="global.html#issue">issue</a></li><li><a href="global.html#lend">lend</a></li><li><a href="global.html#ownerOf">ownerOf</a></li><li><a href="global.html#pledge">pledge</a></li><li><a href="global.html#receipt">receipt</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#revokePermission">revokePermission</a></li><li><a href="global.html#sell">sell</a></li><li><a href="global.html#sendTx">sendTx</a></li><li><a href="global.html#setCode">setCode</a></li><li><a href="global.html#signUp">signUp</a></li><li><a href="global.html#supply">supply</a></li><li><a href="global.html#tokenMetadata">tokenMetadata</a></li><li><a href="global.html#tokenOfOwnerByIndex">tokenOfOwnerByIndex</a></li><li><a href="global.html#totalSupply">totalSupply</a></li><li><a href="global.html#transfer">transfer</a></li><li><a href="global.html#transferFreeze">transferFreeze</a></li><li><a href="global.html#unpledge">unpledge</a></li><li><a href="global.html#updateCode">updateCode</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon Apr 06 2020 23:41:16 GMT+0900 (Japan Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
